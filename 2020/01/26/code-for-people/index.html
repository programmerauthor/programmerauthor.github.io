<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="为抗击新肺炎贡献一份技术力量"><meta name="keywords" content="技术公益"><meta name="author" content="普通程序员"><meta name="copyright" content="普通程序员"><title>为抗击新肺炎贡献一份技术力量 | 普通程序员</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">普通程序员</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">37</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">51</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">51</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">普通程序员</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">为抗击新肺炎贡献一份技术力量</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%85%AC%E7%9B%8A/">公益</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%85%AC%E7%9B%8A/%E5%81%A5%E5%BA%B7/">健康</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2020/01/26/code-for-people/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2020/01/26/code-for-people/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="写在开头"><a href="#写在开头" class="headerlink" title="写在开头"></a>写在开头</h2><p>我不擅长写一些有意思的话，技术也如我的博客名字一样很普通，但是在这个春节，新肺炎肆虐武汉，更不停有扩散在全国的案例消息。</p>
<p>我不是什么专业人士，也无法贡献医疗力量，只能尽我所能看是否能为这件事做一点点的贡献。</p>
<p>这次的新肺炎专家组说了可防可控，但前提是所有人都有防护意识。经常接触互联网的同学们可能防护意识都已经提升起来了，但我相信有不少同学一定听说过或者正在面临着老人防护意识不强，抵制戴口罩，说破嘴皮子，也说服不了平时最爱养生的爸爸妈妈们，不要走亲戚，不要串门，即使有事要出门一定记得戴口罩等等。</p>
<p>我在想这些老人听进去，讲不通道理，归根结底是信息获取不到位，无法感知到形式有多么的严峻。几乎没隔几分钟、十几分钟全国各地都会不停有新的应急措施启动，新的案例产生，全国都处于高度绷紧的状态，这种态势却并没有被老人们清晰的感知到。</p>
<p>如果他们能意识到这些问题的严重性，相信每个人都知道生命是珍贵的，应该重视注意。</p>
<h2 id="获取实时动态"><a href="#获取实时动态" class="headerlink" title="获取实时动态"></a>获取实时动态</h2><p>现在网上谣言漫天飞，可靠的官方信息来源是很重要的。人民日报和丁香医生做了一个实时动态的页面，发布的都是经过可靠验证的实时最新信息-<a href="https://3g.dxy.cn/newh5/view/pneumonia_peopleapp?from=timeline&isappinstalled=0" target="_blank" rel="noopener">实时播报</a>。</p>
<p>但是，这是一个web页面可以通过关注，想要给长辈讲解问题的严重性，及事态的发展，做到有理有据，需要不停地查看这个页面，变得非常的不方便。</p>
<p>我的想法很简单，把这个页面的信息做成接口，这样就可以很方便的作出很多拓展方案。例如，我想通过微信机器人实时通知到群里（由于没有闲置微信老号做机器人未完成），后来又想通过邮件实时发送新动态（这个做了，后面会说），甚至我还想做一个app，将新动态推送的手机上，用语音播放自动朗读出来，成为一个行走的态势宣传喇叭 o(╥﹏╥)o等等，都是需要一个方便的接口才能完成。</p>
<p>所以，就有了下面的内容。</p>
<h2 id="网页转接口"><a href="#网页转接口" class="headerlink" title="网页转接口"></a>网页转接口</h2><p>我第一想法是用 <code>Puppeteer</code> 简单粗暴抓取一下，通常情况下是简单快捷。打开页面分析了一下，发现数据其实都直接放在页面的 <code>&lt;script&gt;</code> 里了，就是的 <code>JavaScript</code> 对象。</p>
<p>这种情况下，其实直接取对象是更快捷的方式。所以采取了 <code>axios</code> + <code>cheerio</code> + <code>node vm</code> 的方案。</p>
<h3 id="网页数据提取"><a href="#网页数据提取" class="headerlink" title="网页数据提取"></a>网页数据提取</h3><p>代码很简单直接贴了：</p>
<ul>
<li>app.js <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">`https://3g.dxy.cn/newh5/view/pneumonia_peopleapp?from=timeline&amp;isappinstalled=0`</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> Axios.get(url);</span><br><span class="line">    <span class="keyword">let</span> html = <span class="keyword">await</span> response.data;</span><br><span class="line">    <span class="keyword">let</span> $ = Cheerio.load(html);</span><br><span class="line">    <span class="keyword">let</span> script = $(<span class="string">'body &gt; script'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(script.length);</span><br><span class="line">    <span class="keyword">var</span> global = &#123;</span><br><span class="line">        <span class="built_in">window</span>:&#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; script.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(script[i] &amp;&amp; script[i].children.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> scriptContent = script[i].firstChild.data;</span><br><span class="line">            vm.createContext(global);</span><br><span class="line">            vm.runInContext(scriptContent, global);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> global.window;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> getData();</span><br><span class="line">    <span class="keyword">await</span> fs.writeJSON(<span class="string">'data/data.json'</span>,data)<span class="comment">//保存数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main().catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error);</span><br><span class="line">    process.exit();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
为了防止对数据源造成压力，这里直接将数据保存到了本地 <code>json</code> 存储，通过 <code>pm2</code> 控制2分钟刷新一次。开放接口直接访问本地的 <code>json</code> 数据，这样对数据源完全没有任何影响。</li>
</ul>
<blockquote>
<p>在我们通过技术手段去采集一些信息时，尽可能避免对数据源产生影响是一种基本的技术道德。</p>
</blockquote>
<h3 id="提供接口"><a href="#提供接口" class="headerlink" title="提供接口"></a>提供接口</h3><p>使用 <code>koa</code> 对外提供接口。</p>
<ul>
<li>api.js<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取所有信息</span></span><br><span class="line">router.get(<span class="string">'/data/all'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> fs.readJSON(<span class="string">'data/data.json'</span>);</span><br><span class="line">    ctx.response.body = data;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取指定省份的信息</span></span><br><span class="line">router.get(<span class="string">'/data/getAreaStat/:provice'</span>, <span class="keyword">async</span> (ctx, next) =&gt;&#123;</span><br><span class="line">    <span class="keyword">var</span> provice = ctx.params.provice;</span><br><span class="line">    <span class="built_in">console</span>.log(ctx.params)</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> fs.readJSON(<span class="string">'data/data.json'</span>);</span><br><span class="line">    <span class="keyword">let</span> areaStat = data.getAreaStat;</span><br><span class="line">    <span class="keyword">if</span>(provice)&#123;</span><br><span class="line">        <span class="keyword">let</span> body = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt;areaStat.length; i++)&#123;</span><br><span class="line">            <span class="keyword">let</span> area = areaStat[i];</span><br><span class="line">            <span class="keyword">if</span>(area.provinceName == provice || area.provinceShortName == provice)&#123;</span><br><span class="line">                body.push(area);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.response.body = body;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        ctx.response.body = areaStat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取信息时间线</span></span><br><span class="line">router.get(<span class="string">'/data/getTimelineService'</span>, <span class="keyword">async</span> (ctx,next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> fs.readJSON(<span class="string">'data/data.json'</span>);</span><br><span class="line">    <span class="keyword">let</span> timeline = data.getTimelineService;</span><br><span class="line">    ctx.response.body = timeline;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取整体统计信息</span></span><br><span class="line">router.get(<span class="string">'/data/getStatisticsService'</span>, <span class="keyword">async</span> (ctx,next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> fs.readJSON(<span class="string">'data/data.json'</span>);</span><br><span class="line">    <span class="keyword">let</span> statistics = data.getStatisticsService;</span><br><span class="line">    ctx.response.body = statistics;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add router middleware:</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3001</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明"></a>接口说明</h2><ul>
<li>/data/getTimelineService</li>
</ul>
<blockquote>
<p>按时间线获取事件</p>
</blockquote>
<ul>
<li>/data/getStatisticsService</li>
</ul>
<blockquote>
<p>获取整体统计信息</p>
</blockquote>
<ul>
<li><p>/data/getAreaStat/:provice</p>
<blockquote>
<p>获取指定省份信息<br>例如：/data/getAreaStat/山东</p>
</blockquote>
</li>
<li><p>/data/all</p>
</li>
</ul>
<blockquote>
<p>获取所有信息</p>
</blockquote>
<ul>
<li>/data/getNewest/:lastid<blockquote>
<p>获取最新事件<br>lastid 代表上次获取到的最后的id<br><br/>例如：/data/getNewest/281<br><br/>将会返回id为281的事件之后发生的事件集合。</p>
</blockquote>
</li>
</ul>
<h2 id="线上服务"><a href="#线上服务" class="headerlink" title="线上服务"></a>线上服务</h2><p>我在服务器上跑了一份，方便有需要的同学使用：</p>
<p>地址：<a href="http://49.232.173.220:3001" target="_blank" rel="noopener">http://49.232.173.220:3001</a><br>测试：<a href="http://49.232.173.220:3001/data/getTimelineService" target="_blank" rel="noopener">http://49.232.173.220:3001/data/getTimelineService</a></p>
<p>项目代码<a href="https://github.com/programmerauthor/spread-information" target="_blank" rel="noopener">在这</a></p>
<h2 id="邮件通知服务"><a href="#邮件通知服务" class="headerlink" title="邮件通知服务"></a>邮件通知服务</h2><p>由于没有闲置的微信老号，制作微信机器人进行通知的想法没有实现，实现了相对成本最低的邮件通知方案。</p>
<p>效果：</p>
<p><img src="/images/code-for-people.assets/image-20200126015202788.png" alt="image-20200126015202788"></p>
<p><img src="/images/code-for-people.assets/image-20200126015230276.png" alt="image-20200126015230276"></p>
<p><img src="/images/code-for-people.assets/image-20200126015134091.png" alt="image-20200126015134091"></p>
<p>如果有需要邮件通知的同学，可以留言你的邮箱，我帮你添加上，就能够收到邮箱通知了。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">普通程序员</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://programmerauthor.github.io/2020/01/26/code-for-people/">https://programmerauthor.github.io/2020/01/26/code-for-people/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://programmerauthor.github.io">普通程序员</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF%E5%85%AC%E7%9B%8A/">技术公益</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/03/centos-font-wqy/"><i class="fa fa-chevron-left">  </i><span>Puppeteer中文显示方块乱码解决</span></a></div><div class="next-post pull-right"><a href="/2020/01/22/android-point-in-path/"><span>Android中如何识别对不规则图形的点击命中</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://programmerauthor.github.io/2020/01/26/code-for-people/';
  this.page.identifier = '2020/01/26/code-for-people/';
  this.page.title = '为抗击新肺炎贡献一份技术力量';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'programmerauthor' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://programmerauthor.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By 普通程序员</div><div class="framework-info"><span>驱动 - <span>Hexo</span></span><span class="footer-separator">|</span><span>主题 - <span>Melody</span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>